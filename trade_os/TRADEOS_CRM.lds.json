{
  "_lds": {
    "uuid": "tradeos-crm-2026-001",
    "type": "ui_component",
    "version": "1.0.0",
    "created": "2026-01-14T03:00:00Z",
    "parent": "tradeos-master-2026-001",
    "phase": 5,
    "sequence": 1
  },
  "core": {
    "name": "TradeOS CRM",
    "description": "Customer relationship management with pipeline, lead tracking, and opportunity stages.",
    "principle": "Office can lead:create, lead:update. Admin can lead:delete. All customer interactions logged."
  },
  "features": {
    "pipeline_kanban": "Visual Kanban board for opportunity stages",
    "lead_sources": "Track where leads come from",
    "opportunity_stages": "Lead → Qualified → Quote → Won/Lost progression",
    "win_loss_analysis": "Reasons for won/lost deals with analytics",
    "customer_ltv": "Lifetime value calculation per customer",
    "activity_timeline": "Full history of interactions per customer",
    "follow_up_reminders": "Scheduled reminders for next actions"
  },
  "react_component": {
    "filename": "CRM.tsx",
    "code": "import React, { useState, useCallback } from 'react';\nimport {\n  Users, UserPlus, Phone, Mail, Calendar, DollarSign, TrendingUp,\n  Clock, CheckCircle2, XCircle, AlertCircle, ChevronRight, ChevronDown,\n  Filter, Search, Plus, MoreVertical, MessageSquare, FileText, Star,\n  ArrowRight, Target, Award, X, MapPin, Building, Tag\n} from 'lucide-react';\nimport { useKernel } from './LDSKernel';\n\ntype OpportunityStage = 'lead' | 'qualified' | 'quote_sent' | 'won' | 'lost';\ntype LeadSource = 'website' | 'referral' | 'google' | 'yelp' | 'facebook' | 'direct_mail' | 'repeat' | 'other';\ntype ActivityType = 'call' | 'email' | 'quote' | 'visit' | 'note' | 'won' | 'lost';\n\ninterface Activity {\n  id: string;\n  type: ActivityType;\n  date: string;\n  description: string;\n  user: string;\n}\n\ninterface Opportunity {\n  id: string;\n  customerName: string;\n  customerEmail: string;\n  customerPhone: string;\n  customerAddress: string;\n  stage: OpportunityStage;\n  source: LeadSource;\n  value: number;\n  probability: number;\n  createdDate: string;\n  lastContact: string;\n  nextFollowUp?: string;\n  assignedTo: string;\n  jobType: string;\n  notes?: string;\n  activities: Activity[];\n  lossReason?: string;\n  wonDate?: string;\n  lostDate?: string;\n}\n\ninterface Customer {\n  id: string;\n  name: string;\n  email: string;\n  phone: string;\n  address: string;\n  source: LeadSource;\n  firstJobDate: string;\n  totalJobs: number;\n  totalRevenue: number;\n  ltv: number;\n  lastJobDate: string;\n  status: 'active' | 'inactive' | 'at_risk';\n}\n\nconst MOCK_OPPORTUNITIES: Opportunity[] = [\n  {\n    id: 'opp-1',\n    customerName: 'New Lead - Martinez',\n    customerEmail: 'martinez@email.com',\n    customerPhone: '(215) 555-0101',\n    customerAddress: '123 Oak Lane, Philadelphia, PA',\n    stage: 'lead',\n    source: 'website',\n    value: 2500,\n    probability: 20,\n    createdDate: '2026-01-14',\n    lastContact: '2026-01-14',\n    nextFollowUp: '2026-01-15',\n    assignedTo: 'Sarah',\n    jobType: 'HVAC Repair',\n    activities: [\n      { id: 'act-1', type: 'note', date: '2026-01-14', description: 'Submitted form on website, AC not cooling', user: 'System' }\n    ]\n  },\n  {\n    id: 'opp-2',\n    customerName: 'Thompson Residence',\n    customerEmail: 'thompson@email.com',\n    customerPhone: '(215) 555-0102',\n    customerAddress: '456 Maple Dr, Philadelphia, PA',\n    stage: 'lead',\n    source: 'referral',\n    value: 8500,\n    probability: 25,\n    createdDate: '2026-01-13',\n    lastContact: '2026-01-13',\n    nextFollowUp: '2026-01-14',\n    assignedTo: 'Mike',\n    jobType: 'HVAC Install',\n    notes: 'Referred by Johnson family',\n    activities: [\n      { id: 'act-2', type: 'call', date: '2026-01-13', description: 'Initial call, interested in new system', user: 'Mike' }\n    ]\n  },\n  {\n    id: 'opp-3',\n    customerName: 'Chen Commercial',\n    customerEmail: 'chen@company.com',\n    customerPhone: '(215) 555-0103',\n    customerAddress: '789 Business Blvd, Philadelphia, PA',\n    stage: 'qualified',\n    source: 'google',\n    value: 15000,\n    probability: 50,\n    createdDate: '2026-01-10',\n    lastContact: '2026-01-13',\n    nextFollowUp: '2026-01-15',\n    assignedTo: 'Sarah',\n    jobType: 'Commercial HVAC',\n    activities: [\n      { id: 'act-3', type: 'call', date: '2026-01-10', description: 'Initial inquiry', user: 'Sarah' },\n      { id: 'act-4', type: 'visit', date: '2026-01-12', description: 'Site visit completed, measured space', user: 'Mike' },\n      { id: 'act-5', type: 'email', date: '2026-01-13', description: 'Sent follow-up with options', user: 'Sarah' }\n    ]\n  },\n  {\n    id: 'opp-4',\n    customerName: 'Wilson Property',\n    customerEmail: 'wilson@email.com',\n    customerPhone: '(215) 555-0104',\n    customerAddress: '321 Pine St, Philadelphia, PA',\n    stage: 'qualified',\n    source: 'yelp',\n    value: 4200,\n    probability: 60,\n    createdDate: '2026-01-08',\n    lastContact: '2026-01-12',\n    assignedTo: 'Mike',\n    jobType: 'Plumbing Repair',\n    activities: [\n      { id: 'act-6', type: 'call', date: '2026-01-08', description: 'Leak in basement', user: 'Mike' },\n      { id: 'act-7', type: 'visit', date: '2026-01-10', description: 'Assessed damage, needs pipe replacement', user: 'James' }\n    ]\n  },\n  {\n    id: 'opp-5',\n    customerName: 'Garcia Home',\n    customerEmail: 'garcia@email.com',\n    customerPhone: '(215) 555-0105',\n    customerAddress: '654 Elm Ave, Philadelphia, PA',\n    stage: 'quote_sent',\n    source: 'facebook',\n    value: 6800,\n    probability: 70,\n    createdDate: '2026-01-05',\n    lastContact: '2026-01-11',\n    nextFollowUp: '2026-01-14',\n    assignedTo: 'Sarah',\n    jobType: 'HVAC Install',\n    activities: [\n      { id: 'act-8', type: 'call', date: '2026-01-05', description: 'Wants to replace old furnace', user: 'Sarah' },\n      { id: 'act-9', type: 'visit', date: '2026-01-07', description: 'Measured, discussed options', user: 'Mike' },\n      { id: 'act-10', type: 'quote', date: '2026-01-09', description: 'Quote sent: Good-Better-Best options', user: 'Sarah' },\n      { id: 'act-11', type: 'email', date: '2026-01-11', description: 'Follow-up on quote', user: 'Sarah' }\n    ]\n  },\n  {\n    id: 'opp-6',\n    customerName: 'Roberts LLC',\n    customerEmail: 'roberts@llc.com',\n    customerPhone: '(215) 555-0106',\n    customerAddress: '987 Commerce Way, Philadelphia, PA',\n    stage: 'quote_sent',\n    source: 'repeat',\n    value: 12500,\n    probability: 80,\n    createdDate: '2026-01-03',\n    lastContact: '2026-01-10',\n    assignedTo: 'Mike',\n    jobType: 'Commercial Plumbing',\n    activities: [\n      { id: 'act-12', type: 'call', date: '2026-01-03', description: 'Bathroom remodel project', user: 'Mike' },\n      { id: 'act-13', type: 'quote', date: '2026-01-08', description: 'Detailed quote sent', user: 'Mike' }\n    ]\n  },\n  {\n    id: 'opp-7',\n    customerName: 'Davis Home',\n    customerEmail: 'davis@email.com',\n    customerPhone: '(215) 555-0107',\n    customerAddress: '147 Birch Rd, Philadelphia, PA',\n    stage: 'won',\n    source: 'referral',\n    value: 3200,\n    probability: 100,\n    createdDate: '2026-01-02',\n    lastContact: '2026-01-12',\n    assignedTo: 'Sarah',\n    jobType: 'HVAC Repair',\n    wonDate: '2026-01-12',\n    activities: [\n      { id: 'act-14', type: 'won', date: '2026-01-12', description: 'Quote accepted, job scheduled', user: 'Sarah' }\n    ]\n  },\n  {\n    id: 'opp-8',\n    customerName: 'Taylor Property',\n    customerEmail: 'taylor@email.com',\n    customerPhone: '(215) 555-0108',\n    customerAddress: '258 Cedar Ln, Philadelphia, PA',\n    stage: 'lost',\n    source: 'google',\n    value: 5500,\n    probability: 0,\n    createdDate: '2026-01-01',\n    lastContact: '2026-01-10',\n    assignedTo: 'Mike',\n    jobType: 'Electrical',\n    lostDate: '2026-01-10',\n    lossReason: 'Went with competitor - lower price',\n    activities: [\n      { id: 'act-15', type: 'lost', date: '2026-01-10', description: 'Lost to competitor on price', user: 'Mike' }\n    ]\n  }\n];\n\nconst MOCK_CUSTOMERS: Customer[] = [\n  { id: 'cust-1', name: 'Johnson Residence', email: 'johnson@email.com', phone: '(215) 555-0201', address: '123 Oak St', source: 'referral', firstJobDate: '2024-03-15', totalJobs: 8, totalRevenue: 12450, ltv: 15800, lastJobDate: '2026-01-10', status: 'active' },\n  { id: 'cust-2', name: 'Smith Commercial', email: 'smith@company.com', phone: '(215) 555-0202', address: '456 Main Ave', source: 'google', firstJobDate: '2023-08-20', totalJobs: 15, totalRevenue: 45200, ltv: 52000, lastJobDate: '2026-01-08', status: 'active' },\n  { id: 'cust-3', name: 'Brown Family', email: 'brown@email.com', phone: '(215) 555-0203', address: '789 Pine Rd', source: 'yelp', firstJobDate: '2025-01-10', totalJobs: 3, totalRevenue: 2850, ltv: 4200, lastJobDate: '2025-11-15', status: 'at_risk' },\n  { id: 'cust-4', name: 'Miller Property', email: 'miller@email.com', phone: '(215) 555-0204', address: '321 Elm St', source: 'website', firstJobDate: '2024-06-22', totalJobs: 5, totalRevenue: 8900, ltv: 11500, lastJobDate: '2025-09-30', status: 'inactive' }\n];\n\nconst STAGE_CONFIG: Record<OpportunityStage, { label: string; color: string; bg: string }> = {\n  lead: { label: 'Lead', color: 'text-slate-600', bg: 'bg-slate-100' },\n  qualified: { label: 'Qualified', color: 'text-blue-600', bg: 'bg-blue-100' },\n  quote_sent: { label: 'Quote Sent', color: 'text-purple-600', bg: 'bg-purple-100' },\n  won: { label: 'Won', color: 'text-green-600', bg: 'bg-green-100' },\n  lost: { label: 'Lost', color: 'text-red-600', bg: 'bg-red-100' }\n};\n\nconst SOURCE_CONFIG: Record<LeadSource, { label: string; icon: React.ReactNode }> = {\n  website: { label: 'Website', icon: <Target className=\"w-4 h-4\" /> },\n  referral: { label: 'Referral', icon: <Users className=\"w-4 h-4\" /> },\n  google: { label: 'Google', icon: <Search className=\"w-4 h-4\" /> },\n  yelp: { label: 'Yelp', icon: <Star className=\"w-4 h-4\" /> },\n  facebook: { label: 'Facebook', icon: <MessageSquare className=\"w-4 h-4\" /> },\n  direct_mail: { label: 'Direct Mail', icon: <Mail className=\"w-4 h-4\" /> },\n  repeat: { label: 'Repeat Customer', icon: <Award className=\"w-4 h-4\" /> },\n  other: { label: 'Other', icon: <Tag className=\"w-4 h-4\" /> }\n};\n\nconst LOSS_REASONS = [\n  'Price too high',\n  'Went with competitor',\n  'Project cancelled',\n  'No response',\n  'Timing not right',\n  'DIY instead',\n  'Other'\n];\n\ntype ViewMode = 'pipeline' | 'customers' | 'analytics';\n\nexport const CRM: React.FC = () => {\n  const { validate, role } = useKernel();\n  const [viewMode, setViewMode] = useState<ViewMode>('pipeline');\n  const [opportunities, setOpportunities] = useState<Opportunity[]>(MOCK_OPPORTUNITIES);\n  const [selectedOpp, setSelectedOpp] = useState<Opportunity | null>(null);\n  const [selectedCustomer, setSelectedCustomer] = useState<Customer | null>(null);\n  const [showAddLead, setShowAddLead] = useState(false);\n  const [searchQuery, setSearchQuery] = useState('');\n  const [draggedOpp, setDraggedOpp] = useState<string | null>(null);\n\n  const handleAddLead = useCallback(() => {\n    const result = validate('lead:create', { authenticated: true });\n    if (result.result !== 'ALLOWED') {\n      alert(`Create lead denied: ${result.reason}`);\n      return;\n    }\n    setShowAddLead(true);\n  }, [validate]);\n\n  const handleMoveStage = useCallback((oppId: string, newStage: OpportunityStage) => {\n    const result = validate('lead:update', { authenticated: true });\n    if (result.result !== 'ALLOWED') {\n      alert(`Update denied: ${result.reason}`);\n      return;\n    }\n    \n    setOpportunities(prev => prev.map(opp => {\n      if (opp.id === oppId) {\n        const updates: Partial<Opportunity> = { stage: newStage };\n        if (newStage === 'won') {\n          updates.wonDate = new Date().toISOString().split('T')[0];\n          updates.probability = 100;\n        } else if (newStage === 'lost') {\n          updates.lostDate = new Date().toISOString().split('T')[0];\n          updates.probability = 0;\n        }\n        return { ...opp, ...updates };\n      }\n      return opp;\n    }));\n    setDraggedOpp(null);\n  }, [validate]);\n\n  const handleDragStart = (oppId: string) => {\n    setDraggedOpp(oppId);\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n  };\n\n  const handleDrop = (stage: OpportunityStage) => {\n    if (draggedOpp) {\n      handleMoveStage(draggedOpp, stage);\n    }\n  };\n\n  const getOpportunitiesByStage = (stage: OpportunityStage) => \n    opportunities.filter(o => o.stage === stage);\n\n  const pipelineValue = opportunities\n    .filter(o => !['won', 'lost'].includes(o.stage))\n    .reduce((sum, o) => sum + (o.value * o.probability / 100), 0);\n\n  const wonThisMonth = opportunities\n    .filter(o => o.stage === 'won')\n    .reduce((sum, o) => sum + o.value, 0);\n\n  const lostThisMonth = opportunities\n    .filter(o => o.stage === 'lost')\n    .reduce((sum, o) => sum + o.value, 0);\n\n  const conversionRate = opportunities.filter(o => o.stage === 'won').length / \n    (opportunities.filter(o => ['won', 'lost'].includes(o.stage)).length || 1) * 100;\n\n  // Pipeline View\n  const PipelineView = () => (\n    <div className=\"space-y-4\">\n      {/* Stats */}\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n        <div className=\"bg-white rounded-xl border border-slate-200 p-4\">\n          <p className=\"text-sm text-slate-500\">Pipeline Value</p>\n          <p className=\"text-2xl font-bold text-slate-800\">${pipelineValue.toLocaleString(undefined, { maximumFractionDigits: 0 })}</p>\n          <p className=\"text-xs text-slate-400\">Weighted by probability</p>\n        </div>\n        <div className=\"bg-white rounded-xl border border-green-200 p-4\">\n          <p className=\"text-sm text-green-600\">Won (MTD)</p>\n          <p className=\"text-2xl font-bold text-green-600\">${wonThisMonth.toLocaleString()}</p>\n        </div>\n        <div className=\"bg-white rounded-xl border border-red-200 p-4\">\n          <p className=\"text-sm text-red-600\">Lost (MTD)</p>\n          <p className=\"text-2xl font-bold text-red-600\">${lostThisMonth.toLocaleString()}</p>\n        </div>\n        <div className=\"bg-white rounded-xl border border-slate-200 p-4\">\n          <p className=\"text-sm text-slate-500\">Win Rate</p>\n          <p className=\"text-2xl font-bold text-slate-800\">{conversionRate.toFixed(0)}%</p>\n        </div>\n      </div>\n\n      {/* Kanban Board */}\n      <div className=\"grid grid-cols-1 md:grid-cols-5 gap-4 overflow-x-auto\">\n        {(['lead', 'qualified', 'quote_sent', 'won', 'lost'] as OpportunityStage[]).map((stage) => {\n          const stageConfig = STAGE_CONFIG[stage];\n          const stageOpps = getOpportunitiesByStage(stage);\n          const stageValue = stageOpps.reduce((sum, o) => sum + o.value, 0);\n          \n          return (\n            <div\n              key={stage}\n              onDragOver={handleDragOver}\n              onDrop={() => handleDrop(stage)}\n              className=\"bg-slate-50 rounded-xl p-3 min-h-[400px]\"\n            >\n              <div className=\"flex items-center justify-between mb-3\">\n                <div className=\"flex items-center gap-2\">\n                  <span className={`px-2 py-1 rounded-full text-xs font-medium ${stageConfig.bg} ${stageConfig.color}`}>\n                    {stageConfig.label}\n                  </span>\n                  <span className=\"text-xs text-slate-400\">{stageOpps.length}</span>\n                </div>\n                <span className=\"text-xs text-slate-500\">${stageValue.toLocaleString()}</span>\n              </div>\n              \n              <div className=\"space-y-2\">\n                {stageOpps.map((opp) => (\n                  <div\n                    key={opp.id}\n                    draggable\n                    onDragStart={() => handleDragStart(opp.id)}\n                    onClick={() => setSelectedOpp(opp)}\n                    className=\"bg-white rounded-lg border border-slate-200 p-3 cursor-pointer hover:border-slate-300 hover:shadow-sm transition-all\"\n                  >\n                    <div className=\"flex items-start justify-between mb-2\">\n                      <p className=\"font-medium text-slate-800 text-sm\">{opp.customerName}</p>\n                      <span className=\"text-xs px-1.5 py-0.5 bg-slate-100 rounded text-slate-600\">\n                        {opp.probability}%\n                      </span>\n                    </div>\n                    <p className=\"text-xs text-slate-500 mb-2\">{opp.jobType}</p>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"font-bold text-slate-800\">${opp.value.toLocaleString()}</span>\n                      <div className=\"flex items-center gap-1\">\n                        {SOURCE_CONFIG[opp.source].icon}\n                      </div>\n                    </div>\n                    {opp.nextFollowUp && !['won', 'lost'].includes(opp.stage) && (\n                      <div className=\"mt-2 pt-2 border-t border-slate-100 flex items-center gap-1 text-xs text-amber-600\">\n                        <Clock className=\"w-3 h-3\" />\n                        Follow up: {opp.nextFollowUp}\n                      </div>\n                    )}\n                  </div>\n                ))}\n              </div>\n            </div>\n          );\n        })}\n      </div>\n    </div>\n  );\n\n  // Customers View\n  const CustomersView = () => (\n    <div className=\"space-y-4\">\n      <div className=\"bg-white rounded-xl border border-slate-200 overflow-hidden\">\n        <div className=\"p-4 border-b border-slate-100 flex items-center gap-4\">\n          <div className=\"flex-1 relative\">\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400\" />\n            <input\n              type=\"text\"\n              placeholder=\"Search customers...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg\"\n            />\n          </div>\n          <select className=\"px-4 py-2 border border-slate-200 rounded-lg\">\n            <option>All Status</option>\n            <option>Active</option>\n            <option>At Risk</option>\n            <option>Inactive</option>\n          </select>\n        </div>\n        <table className=\"w-full\">\n          <thead className=\"bg-slate-50\">\n            <tr>\n              <th className=\"px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase\">Customer</th>\n              <th className=\"px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase\">Source</th>\n              <th className=\"px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase\">Jobs</th>\n              <th className=\"px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase\">Revenue</th>\n              <th className=\"px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase\">LTV</th>\n              <th className=\"px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase\">Last Job</th>\n              <th className=\"px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase\">Status</th>\n            </tr>\n          </thead>\n          <tbody className=\"divide-y divide-slate-100\">\n            {MOCK_CUSTOMERS.map((customer) => (\n              <tr key={customer.id} className=\"hover:bg-slate-50 cursor-pointer\" onClick={() => setSelectedCustomer(customer)}>\n                <td className=\"px-4 py-4\">\n                  <div>\n                    <p className=\"font-medium text-slate-800\">{customer.name}</p>\n                    <p className=\"text-sm text-slate-500\">{customer.email}</p>\n                  </div>\n                </td>\n                <td className=\"px-4 py-4\">\n                  <div className=\"flex items-center gap-2 text-slate-600\">\n                    {SOURCE_CONFIG[customer.source].icon}\n                    <span className=\"text-sm\">{SOURCE_CONFIG[customer.source].label}</span>\n                  </div>\n                </td>\n                <td className=\"px-4 py-4 text-right font-medium text-slate-800\">{customer.totalJobs}</td>\n                <td className=\"px-4 py-4 text-right font-medium text-slate-800\">${customer.totalRevenue.toLocaleString()}</td>\n                <td className=\"px-4 py-4 text-right font-bold text-green-600\">${customer.ltv.toLocaleString()}</td>\n                <td className=\"px-4 py-4 text-sm text-slate-600\">{customer.lastJobDate}</td>\n                <td className=\"px-4 py-4\">\n                  <span className={`px-2 py-1 rounded-full text-xs font-medium ${\n                    customer.status === 'active' ? 'bg-green-100 text-green-700' :\n                    customer.status === 'at_risk' ? 'bg-amber-100 text-amber-700' :\n                    'bg-slate-100 text-slate-600'\n                  }`}>\n                    {customer.status === 'at_risk' ? 'At Risk' : customer.status.charAt(0).toUpperCase() + customer.status.slice(1)}\n                  </span>\n                </td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n\n  // Analytics View\n  const AnalyticsView = () => {\n    const sourceBreakdown = Object.entries(\n      opportunities.reduce((acc, opp) => {\n        acc[opp.source] = (acc[opp.source] || 0) + 1;\n        return acc;\n      }, {} as Record<string, number>)\n    ).sort((a, b) => b[1] - a[1]);\n\n    const lossReasons = opportunities\n      .filter(o => o.stage === 'lost' && o.lossReason)\n      .reduce((acc, opp) => {\n        acc[opp.lossReason!] = (acc[opp.lossReason!] || 0) + 1;\n        return acc;\n      }, {} as Record<string, number>);\n\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n          {/* Lead Sources */}\n          <div className=\"bg-white rounded-xl border border-slate-200 p-6\">\n            <h3 className=\"font-semibold text-slate-800 mb-4\">Lead Sources</h3>\n            <div className=\"space-y-3\">\n              {sourceBreakdown.map(([source, count]) => {\n                const total = opportunities.length;\n                const percent = (count / total) * 100;\n                return (\n                  <div key={source}>\n                    <div className=\"flex items-center justify-between mb-1\">\n                      <div className=\"flex items-center gap-2\">\n                        {SOURCE_CONFIG[source as LeadSource].icon}\n                        <span className=\"text-sm text-slate-700\">{SOURCE_CONFIG[source as LeadSource].label}</span>\n                      </div>\n                      <span className=\"text-sm font-medium text-slate-800\">{count} ({percent.toFixed(0)}%)</span>\n                    </div>\n                    <div className=\"h-2 bg-slate-100 rounded-full overflow-hidden\">\n                      <div className=\"h-full bg-blue-500 rounded-full\" style={{ width: `${percent}%` }} />\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n\n          {/* Loss Reasons */}\n          <div className=\"bg-white rounded-xl border border-slate-200 p-6\">\n            <h3 className=\"font-semibold text-slate-800 mb-4\">Loss Reasons</h3>\n            {Object.keys(lossReasons).length > 0 ? (\n              <div className=\"space-y-3\">\n                {Object.entries(lossReasons).map(([reason, count]) => (\n                  <div key={reason} className=\"flex items-center justify-between p-3 bg-red-50 rounded-lg\">\n                    <span className=\"text-sm text-red-800\">{reason}</span>\n                    <span className=\"font-medium text-red-600\">{count}</span>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <p className=\"text-slate-500 text-sm\">No lost opportunities to analyze</p>\n            )}\n          </div>\n        </div>\n\n        {/* Pipeline by Assignee */}\n        <div className=\"bg-white rounded-xl border border-slate-200 p-6\">\n          <h3 className=\"font-semibold text-slate-800 mb-4\">Pipeline by Sales Rep</h3>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            {['Sarah', 'Mike'].map((rep) => {\n              const repOpps = opportunities.filter(o => o.assignedTo === rep && !['won', 'lost'].includes(o.stage));\n              const repValue = repOpps.reduce((sum, o) => sum + o.value, 0);\n              const repWon = opportunities.filter(o => o.assignedTo === rep && o.stage === 'won').reduce((sum, o) => sum + o.value, 0);\n              return (\n                <div key={rep} className=\"p-4 border border-slate-200 rounded-lg\">\n                  <div className=\"flex items-center gap-3 mb-3\">\n                    <div className=\"w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-medium\">\n                      {rep[0]}\n                    </div>\n                    <div>\n                      <p className=\"font-medium text-slate-800\">{rep}</p>\n                      <p className=\"text-sm text-slate-500\">{repOpps.length} active opportunities</p>\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <p className=\"text-sm text-slate-500\">Pipeline</p>\n                      <p className=\"font-bold text-slate-800\">${repValue.toLocaleString()}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-sm text-green-600\">Won (MTD)</p>\n                      <p className=\"font-bold text-green-600\">${repWon.toLocaleString()}</p>\n                    </div>\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Header */}\n      <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-slate-800\">CRM</h1>\n          <p className=\"text-slate-500\">Manage leads, opportunities, and customers</p>\n        </div>\n        <button\n          onClick={handleAddLead}\n          className=\"px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 flex items-center gap-2\"\n        >\n          <UserPlus className=\"w-4 h-4\" />\n          Add Lead\n        </button>\n      </div>\n\n      {/* View Tabs */}\n      <div className=\"bg-white rounded-xl border border-slate-200 p-1 inline-flex\">\n        {[\n          { id: 'pipeline', label: 'Pipeline', icon: <Target className=\"w-4 h-4\" /> },\n          { id: 'customers', label: 'Customers', icon: <Users className=\"w-4 h-4\" /> },\n          { id: 'analytics', label: 'Analytics', icon: <TrendingUp className=\"w-4 h-4\" /> }\n        ].map((view) => (\n          <button\n            key={view.id}\n            onClick={() => setViewMode(view.id as ViewMode)}\n            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 ${\n              viewMode === view.id\n                ? 'bg-orange-100 text-orange-700'\n                : 'text-slate-600 hover:text-slate-800'\n            }`}\n          >\n            {view.icon}\n            {view.label}\n          </button>\n        ))}\n      </div>\n\n      {/* Content */}\n      {viewMode === 'pipeline' && <PipelineView />}\n      {viewMode === 'customers' && <CustomersView />}\n      {viewMode === 'analytics' && <AnalyticsView />}\n\n      {/* Opportunity Detail Slide-over */}\n      {selectedOpp && (\n        <div className=\"fixed inset-0 bg-black/50 flex justify-end z-50\">\n          <div className=\"bg-white w-full max-w-lg overflow-y-auto\">\n            <div className=\"p-4 border-b border-slate-200 flex items-center justify-between sticky top-0 bg-white\">\n              <h3 className=\"font-semibold text-slate-800\">{selectedOpp.customerName}</h3>\n              <button onClick={() => setSelectedOpp(null)} className=\"p-2 hover:bg-slate-100 rounded-lg\">\n                <X className=\"w-5 h-5 text-slate-600\" />\n              </button>\n            </div>\n            <div className=\"p-4 space-y-4\">\n              {/* Stage */}\n              <div className=\"flex items-center justify-between\">\n                <span className={`px-3 py-1 rounded-full text-sm font-medium ${STAGE_CONFIG[selectedOpp.stage].bg} ${STAGE_CONFIG[selectedOpp.stage].color}`}>\n                  {STAGE_CONFIG[selectedOpp.stage].label}\n                </span>\n                <span className=\"text-2xl font-bold text-slate-800\">${selectedOpp.value.toLocaleString()}</span>\n              </div>\n              \n              {/* Contact Info */}\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center gap-3 text-slate-600\">\n                  <Mail className=\"w-4 h-4\" />\n                  <span>{selectedOpp.customerEmail}</span>\n                </div>\n                <div className=\"flex items-center gap-3 text-slate-600\">\n                  <Phone className=\"w-4 h-4\" />\n                  <span>{selectedOpp.customerPhone}</span>\n                </div>\n                <div className=\"flex items-center gap-3 text-slate-600\">\n                  <MapPin className=\"w-4 h-4\" />\n                  <span>{selectedOpp.customerAddress}</span>\n                </div>\n              </div>\n              \n              {/* Details */}\n              <div className=\"grid grid-cols-2 gap-4 p-4 bg-slate-50 rounded-lg\">\n                <div>\n                  <p className=\"text-sm text-slate-500\">Job Type</p>\n                  <p className=\"font-medium text-slate-800\">{selectedOpp.jobType}</p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-slate-500\">Source</p>\n                  <p className=\"font-medium text-slate-800 flex items-center gap-2\">\n                    {SOURCE_CONFIG[selectedOpp.source].icon}\n                    {SOURCE_CONFIG[selectedOpp.source].label}\n                  </p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-slate-500\">Probability</p>\n                  <p className=\"font-medium text-slate-800\">{selectedOpp.probability}%</p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-slate-500\">Assigned To</p>\n                  <p className=\"font-medium text-slate-800\">{selectedOpp.assignedTo}</p>\n                </div>\n              </div>\n              \n              {/* Activity Timeline */}\n              <div>\n                <h4 className=\"font-medium text-slate-800 mb-3\">Activity Timeline</h4>\n                <div className=\"space-y-3\">\n                  {selectedOpp.activities.map((activity) => (\n                    <div key={activity.id} className=\"flex gap-3\">\n                      <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${\n                        activity.type === 'call' ? 'bg-blue-100 text-blue-600' :\n                        activity.type === 'email' ? 'bg-purple-100 text-purple-600' :\n                        activity.type === 'visit' ? 'bg-green-100 text-green-600' :\n                        activity.type === 'quote' ? 'bg-amber-100 text-amber-600' :\n                        activity.type === 'won' ? 'bg-green-100 text-green-600' :\n                        activity.type === 'lost' ? 'bg-red-100 text-red-600' :\n                        'bg-slate-100 text-slate-600'\n                      }`}>\n                        {activity.type === 'call' && <Phone className=\"w-4 h-4\" />}\n                        {activity.type === 'email' && <Mail className=\"w-4 h-4\" />}\n                        {activity.type === 'visit' && <MapPin className=\"w-4 h-4\" />}\n                        {activity.type === 'quote' && <FileText className=\"w-4 h-4\" />}\n                        {activity.type === 'note' && <MessageSquare className=\"w-4 h-4\" />}\n                        {activity.type === 'won' && <CheckCircle2 className=\"w-4 h-4\" />}\n                        {activity.type === 'lost' && <XCircle className=\"w-4 h-4\" />}\n                      </div>\n                      <div className=\"flex-1\">\n                        <p className=\"text-sm text-slate-800\">{activity.description}</p>\n                        <p className=\"text-xs text-slate-400\">{activity.date} • {activity.user}</p>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </div>\n              \n              {/* Actions */}\n              {!['won', 'lost'].includes(selectedOpp.stage) && (\n                <div className=\"flex gap-2\">\n                  <button className=\"flex-1 py-2 border border-slate-200 rounded-lg hover:bg-slate-50 flex items-center justify-center gap-2\">\n                    <Phone className=\"w-4 h-4\" />\n                    Log Call\n                  </button>\n                  <button className=\"flex-1 py-2 border border-slate-200 rounded-lg hover:bg-slate-50 flex items-center justify-center gap-2\">\n                    <Mail className=\"w-4 h-4\" />\n                    Send Email\n                  </button>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Add Lead Modal */}\n      {showAddLead && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-2xl w-full max-w-lg mx-4\">\n            <div className=\"p-4 border-b border-slate-200 flex items-center justify-between\">\n              <h3 className=\"font-semibold text-slate-800\">Add New Lead</h3>\n              <button onClick={() => setShowAddLead(false)} className=\"p-2 hover:bg-slate-100 rounded-lg\">\n                <X className=\"w-5 h-5 text-slate-600\" />\n              </button>\n            </div>\n            <div className=\"p-4 space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-slate-700 mb-1\">Customer Name</label>\n                <input type=\"text\" placeholder=\"e.g. Johnson Residence\" className=\"w-full px-4 py-2 border border-slate-200 rounded-lg\" />\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-slate-700 mb-1\">Email</label>\n                  <input type=\"email\" placeholder=\"email@example.com\" className=\"w-full px-4 py-2 border border-slate-200 rounded-lg\" />\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-slate-700 mb-1\">Phone</label>\n                  <input type=\"tel\" placeholder=\"(215) 555-0000\" className=\"w-full px-4 py-2 border border-slate-200 rounded-lg\" />\n                </div>\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-slate-700 mb-1\">Address</label>\n                <input type=\"text\" placeholder=\"123 Main St, Philadelphia, PA\" className=\"w-full px-4 py-2 border border-slate-200 rounded-lg\" />\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-slate-700 mb-1\">Lead Source</label>\n                  <select className=\"w-full px-4 py-2 border border-slate-200 rounded-lg\">\n                    {Object.entries(SOURCE_CONFIG).map(([key, config]) => (\n                      <option key={key} value={key}>{config.label}</option>\n                    ))}\n                  </select>\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-slate-700 mb-1\">Job Type</label>\n                  <select className=\"w-full px-4 py-2 border border-slate-200 rounded-lg\">\n                    <option>HVAC Repair</option>\n                    <option>HVAC Install</option>\n                    <option>Plumbing Repair</option>\n                    <option>Plumbing Install</option>\n                    <option>Electrical</option>\n                  </select>\n                </div>\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-slate-700 mb-1\">Estimated Value</label>\n                <input type=\"number\" placeholder=\"5000\" className=\"w-full px-4 py-2 border border-slate-200 rounded-lg\" />\n              </div>\n              <div className=\"flex gap-3\">\n                <button\n                  onClick={() => setShowAddLead(false)}\n                  className=\"flex-1 py-2 border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={() => { setShowAddLead(false); alert('Lead created!'); }}\n                  className=\"flex-1 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600\"\n                >\n                  Add Lead\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default CRM;"
  }
}